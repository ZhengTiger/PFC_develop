---
author: "Hu Zheng"
date: "2024-12-01"
date-format: YYYY-MM-DD
---

# monocle3 拟时序分析

```{r}
library(Seurat)
library(monocle)
library(ggplot2)
```

```{r}
seu.harmony <- readRDS('../../data/rds/seu.harmony.rds')
seu.harmony.metadata <- readRDS('../../data/rds/seu.harmony.metadata.rds')
seu.harmony@meta.data <- seu.harmony.metadata
```


提取 seurat 中的数据，构建 cds 对象：

```{r}
expr_matrix <- GetAssayData(seu.harmony, assay = 'RNA', slot = 'counts')
p_data <- seu.harmony@meta.data
f_data <- data.frame(gene_short_name = rownames(expr_matrix))
rownames(f_data) <- rownames(expr_matrix)

pd <- new("AnnotatedDataFrame", data = p_data)
fd <- new("AnnotatedDataFrame", data = f_data)
cds <- newCellDataSet(as(as.matrix(expr_matrix), "sparseMatrix"),
                      phenoData = pd, featureData = fd,
                      lowerDetectionLimit = 0.5,
                      expressionFamily = negbinomial.size())
```


估计size factor和离散度:

```{r}
cds <- estimateSizeFactors(cds)
cds <- estimateDispersions(cds)
```

过滤<10个细胞的gene

```{r}
cds <- detectGenes(cds, min_expr = 0.1)
expressed_genes <- row.names(subset(fData(cds), num_cells_expressed >= 10))
```








